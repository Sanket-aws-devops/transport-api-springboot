name: Java with Gradle 

on:
  push:
    branches: [ "main" ]

jobs:
  build-deploy:
    runs-on: self-hosted

    env:
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build API
        run: ./gradlew clean build

      - name: Deploy and run API
        run: |
          cp build/libs/*.jar /opt/transport-api/transport-api.jar
          
          # Export env vars and restart service with these variables
          export DB_NAME=$DB_NAME
          export DB_USERNAME=$DB_USERNAME
          export DB_PASSWORD=$DB_PASSWORD
          
          #sudo systemctl stop my-api-service || true
          java -jar build/libs/*.jar
          #sudo systemctl start my-api-service
