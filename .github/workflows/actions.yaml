name: Deploy Java API to EC2 (Dev)

on:
  push:
    branches: [ "main" ]

jobs:
  build-deploy:
    runs-on: self-hosted
    environment: dev   # üëà Environment-scoped secrets used here

    env:
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v3

      - name: üõ†Ô∏è Build API with Gradle
        run: ./gradlew clean build

      - name: üöÄ Deploy and Start API
        run: |
          echo "Copying JAR..."
          cp build/libs/*.jar /opt/transport-api/transport-api.jar

          echo "Exporting DB environment variables..."
          export SERVER_PORT=$SERVER_PORT
          export DB_NAME=$DB_NAME
          export DB_USERNAME=$DB_USERNAME
          export DB_PASSWORD=$DB_PASSWORD

          echo "Running API in background..."
          nohup java -Dserver.port=$SERVER_PORT \
                     -Dspring.datasource.url=jdbc:mysql://<your-db-host>:3306/$DB_NAME \
                     -Dspring.datasource.username=$DB_USERNAME \
                     -Dspring.datasource.password=$DB_PASSWORD \
                     -jar /opt/transport-api/transport-api.jar > api.log 2>&1 &

          echo "API started. PID: $(pgrep -f transport-api.jar)"
