name: Deploy Java API to EC2 (Dev)

on:
  push:
    branches: [ "main" ]

jobs:
  build-deploy:
    runs-on: self-hosted
    environment: Dev  

    env:
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      DB_URL: ${{ secrets.DB_URL }}               
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    steps:
      - name:  Checkout code
        uses: actions/checkout@v3

      - name: Grant execute permission to Gradle wrapper
        run: chmod +x ./gradlew

      - name: ðŸ›  Build API with Gradle
        run: ./gradlew clean build

      - name:  Deploy and Run API
        run: |
          echo "Copying JAR to target directory..."
          cp build/libs/*.jar /opt/transport-api/transport-api.jar

          echo "Exporting environment variables..."
          export SERVER_PORT=$SERVER_PORT
          export DB_URL=$DB_URL
          export DB_USERNAME=$DB_USERNAME
          export DB_PASSWORD=$DB_PASSWORD

          echo "Starting API with environment-specific configs..."
          nohup java \
            -Dserver.port=$SERVER_PORT \
            -Dspring.datasource.url=$DB_URL \
            -Dspring.datasource.username=$DB_USERNAME \
            -Dspring.datasource.password=$DB_PASSWORD \
            -jar /opt/transport-api/transport-api.jar > /opt/transport-api/api.log 2>&1 &

          echo " API started in the background"
